---
title: "Auto mapping ICD10fi to ICD10who"
output: 
    github_document:
        df_print: tibble
        toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate)
library(scales)
library(readxl)
```


# Load ICD10fi automaticaly matched to ICD10who, and FinnGen adn TAYS freqs

```{r load, message=FALSE}
icd10fi_standard_matched <- read_csv("./ICD10fi_matched_to_ICD10who.csv") %>% 
  mutate(ICD10who_match_level = factor(ICD10who_match_level, 
                                     levels = c("classification_code", 
                                                "match_exactly", 
                                                "match_one_code_removing_mark",
                                                "match_longName",
                                                "match_first_code",
                                                "match_first_code_parent", 
                                                "match_first_code_grandparent", 
                                                "no_match")
                                    )
      )

freq_icd10fi_finngen <- read_csv("../1_source_codes_freq//freq_ICD10fi_finngen.csv", ) %>% select(-X1)
freq_icd10_tays <- read_csv("../1_source_codes_freq//freq_ICD10fi_tays.csv", 
                               col_types = cols( .default = col_character() )) %>% 
  mutate( frequency = as.integer(frequency))
```

# first confirm the match that dont fit the exact name by mapping them to ICD10who

```{r}
icd10_almost<-icd10fi_standard_matched %>%  filter(exists_in_ICD10who) %>%  filter(English_name_match_level>0) %>% select(CodeId, English_name, ICD10who_name,English_name_match_level ) %>% arrange(English_name_match_level)
```


```{r}
write_csv(icd10_almost , "./same_icd10who_code_not_exactly_same_english_name.csv")
```

Match tese to ICD10 using USAGI. 

# From these that have not match 

```{r}
## icd10fi standard
#remove classification codes
icd10fi_standard_matched <- icd10fi_standard_matched %>%  filter(ICD10who_match_level!="classification_code")

# format them similarly 
icd10fi_standard_matched <- icd10fi_standard_matched %>% 
  mutate(CODE1 = str_replace(Code1,"\\.", ""), CODE2 = str_replace(Code2,"\\.", ""))

#There is 11 that are repeated looking at code1 and code 2
duplicates_CodeId <- icd10fi_standard_matched %>%  count(Code1, Code2, sort = T) %>% filter(n>1) %>%  select(-n) %>% 
  inner_join(icd10fi_standard_matched, by=c("Code1", "Code2")) %>% 
  filter(Code1!=CodeId) %>% .$CodeId

#remove these 
icd10fi_standard_matched <- icd10fi_standard_matched %>% filter(!(CodeId %in% duplicates_CodeId))


# finngen
freq_icd10fi_finngen <- freq_icd10fi_finngen %>% 
  rename(freq_finngen = n_codes) %>% 
  mutate(CODE1 = str_replace(CODE1,"\\+|\\*|\\#|\\&", ""), CODE2 = str_replace(CODE2,"\\+|\\*|\\#|\\&", "")) %>% 
  # if same code sum freqs
  group_by(CODE1, CODE2) %>% summarise(freq_finngen=sum(freq_finngen),  n_patients=sum(n_patients)) %>% ungroup()



freq_icd10_tays <- freq_icd10_tays %>%  mutate(CODE1 = str_replace(dg, "([:alnum:]*)\\s([:alnum:]*)", "\\1")) %>% 
   mutate(CODE2 = if_else(str_detect(dg, "\\s"), str_replace(dg, "([:alnum:]*)\\s([:alnum:]*)", "\\2"), as.character(NA))) %>% 
  mutate(frequency = as.double(frequency)) %>% 
  rename(freq_tays = frequency) %>% select(CODE1, CODE2, freq_tays) %>%  distinct() %>% 
  group_by(CODE1, CODE2) %>% summarise(freq_tays=sum(freq_tays))%>% ungroup()
```

Codes automatically matched to ICD10who by match type: 
```{r}
icd10fi_standard_matched  %>% count(ICD10who_match_level, exists_in_ICD10who) 
```

Number of events in each data base :
```{r}
n_events_finngen <- freq_icd10fi_finngen$freq_finngen %>% sum()
n_events_tays <- freq_icd10_tays$freq_tays %>% sum()

n_events_finngen
n_events_tays
```

## Improtant
Notice that some icd10fi are different but have the same meaning. We leave all of these here as the aim is to map the CodeId column. 



## Study codes in FinnGen

```{r}
finngen_join <- left_join(freq_icd10fi_finngen, icd10fi_standard_matched, by = c("CODE1", "CODE2"))
```

**How many codes labeled as icd10fi in FinnGen are not in the icd10fi standard ?**
```{r paged.print=TRUE}
no_finngen_standard <- finngen_join %>% filter(is.na(ShortName)) %>% select(CodeId, ShortName, CODE1,  CODE2, freq_finngen) %>%
  mutate( freq_finngen_per=percent(freq_finngen/n_events_finngen))
```

There are `r no_finngen_standard %>%  nrow()` codes not found in the standard.
However, `r no_finngen_standard %>% filter(CODE1 == CODE2) %>%  nrow()` are not found because they have the same CODE1 and CODE2.
If we remove these, here are `r no_finngen_standard %>% filter((CODE1 != CODE2) | (is.na(CODE1)) | (is.na(CODE2)) ) %>%  nrow()` codes not found in the standard:

```{r paged.print=TRUE}
no_finngen_standard %>% filter((CODE1 != CODE2) | (is.na(CODE1)) | (is.na(CODE2)) ) %>% 
  filter(! (is.na(CODE1) & !is.na(CODE2)) ) %>% 
  arrange(-freq_finngen)
```

Save these as: `finngefreq_finngen_not_in_icd10fi.csv`

Most of these are not found bcs they combination is not in `CodeId` but explained in `ALONG:Huom.`. This will be solved at the end of the process. 

```{r}
write_csv(no_finngen_standard, "./finngefreq_finngen_not_in_icd10fi.csv")
```

**How many codes and freq in FinnGen is already mapped by the automatching ? **

```{r}
finngen_standard <- finngen_join %>% filter(!is.na(ShortName)) %>% 
  select(CodeId, ShortName, English_name, CODE1,  CODE2, freq_finngen, ICD10who_match_level, exists_in_ICD10who) %>% 
  mutate( freq_finngen_per=(freq_finngen/n_events_finngen))

finngen_standard  %>% group_by(exists_in_ICD10who) %>%  summarise(n=n(), freq = percent(sum(freq_finngen_per)))
```


## Study codes in TAYS

```{r}
tays_join <- left_join(freq_icd10_tays, icd10fi_standard_matched, by = c("CODE1", "CODE2"))
```

**How many codes labeled as icd10fi in FinnGen are not in the icd10fi standard ?**
```{r paged.print=TRUE}
no_tays_standard <- tays_join %>% filter(is.na(ShortName)) %>% select(CodeId, ShortName, CODE1,  CODE2, freq_tays) %>%
  mutate( freq_tays_per=percent(freq_tays/n_events_tays))
```

There are `r no_tays_standard %>%  nrow()` codes not found in the standard.

```{r paged.print=TRUE}
no_tays_standard 
```

Save these as: `tays_codes_not_in_icd10fi.csv`
```{r}
write_csv(no_tays_standard, "./tays_codes_not_in_icd10fi.csv")
```

**How many codes and freq in FinnGen is already mapped by the auto-matching ? **

```{r}
tays_standard <- tays_join %>% filter(!is.na(ShortName)) %>% 
  select(CodeId, ShortName, English_name, CODE1,  CODE2, freq_tays, ICD10who_match_level, exists_in_ICD10who) %>% 
  mutate( freq_tays_per=(freq_tays/n_events_tays))

tays_standard  %>% group_by(exists_in_ICD10who) %>%  summarise(n=n(), freq = percent(sum(freq_tays_per)))
```
# Merge all 

```{r}
tmp <- left_join(icd10fi_standard_matched, finngen_standard %>% select(CodeId, freq_finngen), by = c("CodeId"))
icd10_standard_with_freqs <- left_join(tmp ,  tays_standard %>% select(CodeId, freq_tays), by = c("CodeId"))
```


```{r}
icd10_standard_with_freqs <- icd10_standard_with_freqs %>%   mutate(freq_total = (freq_finngen+freq_tays))

icd10_standard_with_freqs %>%  arrange(-freq_total) %>%  select(CodeId,  freq_finngen, freq_tays, freq_total) %>% 
  mutate(freq_total_per = scales::percent(freq_total/(n_events_finngen+n_events_tays))) 

```


```{r}
icd10_standard_with_freqs %>%
  group_by(exists_in_ICD10who) %>%  summarise(n=n(), freq = percent(sum(freq_total, na.rm = T)/(n_events_finngen+n_events_tays)))
```

# Remove already matched

Save as: `standard_icd10fi_with_freq.csv`

```{r}
icd10_standard_with_freqs_tmp <- icd10_standard_with_freqs %>% 
  filter(!exists_in_ICD10who) %>%
  select(CodeId, LongName, English_name, freq_finngen, freq_tays, freq_total, ICD10who_match_level )  %>% 
  mutate_if(is.numeric, ~if_else(is.na(.), rep(0, length(.)), .))
```


**how many with no english names ?**

```{r}
icd10_standard_with_freqs_tmp %>% mutate(has_english_name = !is.na(English_name)) %>% 
  group_by(has_english_name) %>%  summarise(n=n(), freq = percent(sum(freq_total, na.rm = T)/(n_events_finngen+n_events_tays)))
```


```{r}
write_csv(icd10_standard_with_freqs_tmp , "./standard_icd10fi_with_freq.csv")
```


