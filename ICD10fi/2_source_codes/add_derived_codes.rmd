---
title: "add derived codes"
output: 
    github_document:
        df_print: tibble
        toc: true
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate)
library(scales)
library(stringdist)
```


# Load ICD10fi

```{r load, message=FALSE}

ICD10fi <- read_delim("./58_1471433699473.txt", ";", 
                               locale = locale(encoding = 'ISO-8859-1'),
                               col_types = cols( .default = col_character() )
                               )

```

Get codes with a described expansion in `ALONG:Huom.`

```{r}
icd10fi_expansion_description <- ICD10fi %>% 
  filter(!is.na(`A:Yhdistelymerkki`)) %>% 
  filter(!str_detect(CodeId,"[:digit:]$")) %>% #dont end with mark
  filter(str_detect(`ALONG:Huom.`, "[:upper:][:digit:][:digit:]")) %>% 
  filter(str_detect(`ALONG:Huom.`, "tiologi")) %>% 
  arrange(`ALONG:Huom.`) %>% 
  select(CodeId,`ALONG:Huom.`) 

icd10fi_expansion_description
```

There are 2 types of expansion: 
- Added single code "Etiologiseksi koodiksi valitaan Xxx.x"
- To chose from a chapter/group "Etiologinen koodi valitaan ryhmistä"


## Expand one code addition
```{r}
#code
icd10fi_extended_by_one_code <- 
icd10fi_expansion_description %>% filter(str_detect(`ALONG:Huom.`, "koodik") & !str_detect(`ALONG:Huom.`, "Lisäksi")) %>% 
 mutate(codes_text = str_extract(`ALONG:Huom.`, "[:upper:][:digit:][:digit:].*")) %>% 
  mutate(codes_text = str_replace(codes_text, "(.*)\\s-\\s.*", "\\1")) %>% 
  # tai to , 
  mutate_at(vars(codes_text), str_replace_all,"\\stai\\s", "|")
```

```{r}
icd10fi_extended_by_one_code <- icd10fi_extended_by_one_code %>% 
  mutate(code2 = map(codes_text, ~{str_split(.,"\\|") %>% unlist() %>% as_tibble()})) %>% unnest(code2) %>% 
  mutate(new_CodeId = str_c(CodeId, value))
  
icd10fi_extended_by_one_code

```

How many already exists
```{r}
new_icd10fi_extended_by_one_code <- left_join(icd10fi_extended_by_one_code, 
          ICD10fi %>% select(CodeId) %>% rename(new_CodeId = CodeId) %>% mutate(is=TRUE), 
          by="new_CodeId"
) %>%
  filter(is.na(is))

new_icd10fi_extended_by_one_code
```
31 of the already exists 






## Expand by class/chapter/group
```{r}
range_to_regex <- function(match){
  range <- str_extract_all(match, "[:digit:][:digit:]") %>% unlist() %>% as.integer()
  match <- range[1]:range[2] %>% as.character() %>% if_else(nchar(.)==1, str_c("0",.),.) %>% str_c(collapse = "|")
  return(str_c("(",match,")"))
}

#group
icd10fi_extended_by_group <- 
icd10fi_expansion_description %>% filter(str_detect(`ALONG:Huom.`, "luokasta|luvusta|ryhmistä|ryhmästä|rymistä")) %>% 
  #extract codes
  mutate(group_text = str_extract(`ALONG:Huom.`, "[:upper:][:digit:][:digit:].*")) %>% 
  mutate(group_text = str_replace(group_text, "(.*)\\s-\\s.*", "\\1")) %>% 
  mutate(group_text = str_replace(group_text, "(.*)\\.\\s.*", "\\1")) %>% 
  mutate(group_text = str_replace(group_text, "(.*)\\.\\s.*", "\\1")) %>% 
  #extract negations
  mutate(group_text_ei = str_extract(group_text, "\\(ei.*\\)")) %>% 
  mutate(group_text = str_remove(group_text, "\\s\\(ei.*\\)")) %>% 
  mutate(group_text_ei = str_replace(group_text_ei, "\\(ei\\s(.*)\\)", "\\1")) %>% 
  # tai to , 
  mutate_at(vars(group_text, group_text_ei), str_replace_all, "\\stai\\sryhmistä\\s|\\stai\\sryhmästä\\s|,\\s|\\stai\\s", "|") %>%
  # format as regex
  mutate(group_reg=group_text, group_reg_ei=group_text_ei) %>% 
  mutate(group_reg = str_replace(group_reg, "C00-D", "C00-C99\\|D00-D")) %>% 
  mutate(group_reg = str_replace(group_reg, "A([:digit:][:digit:])-B", "A\\1-A99\\|B00-B")) %>% 
  mutate_at(vars(group_reg,group_reg_ei), str_replace_all, "-[:upper:]", "-" ) %>% 
  #mutate_at(vars(group_reg,group_reg_ei), str_replace_all, "([:digit:][:digit:]-[:digit:][:digit:])", "\\[\\1\\]" ) %>% 
  mutate_at(vars(group_reg,group_reg_ei), str_replace_all, "\\|", "|^" ) %>% 
  mutate_at(vars(group_reg,group_reg_ei), ~{str_c("^",.)} ) %>% 
  mutate(group_reg = str_replace_all(group_reg, "[:digit:][:digit:]-[:digit:][:digit:]", range_to_regex)) %>% 
  mutate(group_reg_ei = str_replace_all(group_reg_ei, "50-53", "(50|51|52|53)"))%>% 
  #extract merkki
  mutate(group_reg_4merkki = str_extract(`ALONG:Huom.`, "(\\.[:digit:])($|\\.$)")) %>% 
  mutate(group_reg_4merkki = str_replace(group_reg_4merkki, "\\.$", "")) %>% 
  mutate(group_reg_4merkki = str_c(group_reg_4merkki, "$") ) 

  
  
  icd10fi_extended_by_group %>% select(group_text, group_reg, group_reg_ei, group_reg_4merkki) %>% print(n=300)

```

Expand rules for  `H36.00*	Etiologinen koodi valitaan tässä ryhmässä ryhmistä E10-E14. Neljäs merkki on .3`

```{r}
a<-ICD10fi %>% filter(ParentId == "H36*") %>% filter(is.na(`A:Koodi2`)) %>%  select(CodeId)
b <- icd10fi_extended_by_group %>% filter(CodeId == "H36.00*")
b$CodeId[1] = a
b <- b %>%  unnest(CodeId)

icd10fi_extended_by_group <- bind_rows(icd10fi_extended_by_group, b) %>%  distinct()

```


Extend leaves only 
```{r}
icd10fi_leaves <- ICD10fi %>% 
    filter(`A:Lehtisolmu`=="T" & is.na(`A:Yhdistelymerkki`))
```



```{r}
icd10fi_extended_by_group <- icd10fi_extended_by_group %>% #slice(1)%>% 
  mutate(code2 = pmap(list(group_reg, group_reg_ei, group_reg_4merkki), 
                      function(group_reg, group_reg_ei, group_reg_4merkki){
                        icd10fi_leaves %>% select(CodeId) %>%  
                          filter(str_detect(CodeId, group_reg)) %>% 
                          filter(is.na(group_reg_ei)      | !str_detect(CodeId, group_reg_ei)) %>% 
                          filter(is.na(group_reg_4merkki) |  str_detect(CodeId, group_reg_4merkki)) %>% 
                          rename(CodeId2 = CodeId)
  })) %>% unnest(code2)  %>% 
  mutate(new_CodeId = str_c(CodeId, CodeId2))
  
icd10fi_extended_by_group

```


How many already exists
```{r}
new_icd10fi_extended_by_group <- left_join(icd10fi_extended_by_group, 
          ICD10fi %>% select(CodeId) %>% rename(new_CodeId = CodeId) %>% mutate(is=TRUE), 
          by="new_CodeId"
) %>%
  filter(is.na(is))

new_icd10fi_extended_by_group
```
256 already exists 




## Append the new codes to the standard


```{r}

all_codes_tmp <- bind_rows(
  ICD10fi %>% rename(CODE1=`A:Koodi1`, CODE2=`A:Koodi2`)  %>%
    mutate(orginal=TRUE) %>%  
    select(CodeId, CODE1, CODE2), 
  new_icd10fi_extended_by_one_code %>%  rename(CODE1 = CodeId, CodeId = new_CodeId, CODE2 = value) %>% 
    mutate(CODE1 = str_extract(CODE1, "[:upper:][:digit:][:digit:]\\.?[:digit:]"), orginal=FALSE) %>% 
    select(CodeId, CODE1, CODE2, orginal),
  new_icd10fi_extended_by_group %>%  rename(CODE1 = CodeId, CodeId = new_CodeId, CODE2 = CodeId2) %>% 
    mutate(CODE1 = str_extract(CODE1, "[:upper:][:digit:][:digit:]\\.?[:digit:]"), orginal=FALSE) %>% 
    select(CodeId, CODE1, CODE2, orginal),
)

```


```{r}
write_csv(all_codes_tmp, "./ICD10_extended.csv")
```


















#

```{r}
freq_icd10fi_finngen <- read_csv("../1_source_codes_freq/freq_ICD10fi_finngen.csv", ) %>% select(-X1)

freq_icd10fi_finngen <- freq_icd10fi_finngen %>% 
  rename(freq_finngen = n_codes) %>% 
  mutate(CODE1 = str_replace(CODE1,"\\+|\\*|\\#|\\&", ""), CODE2 = str_replace(CODE2,"\\+|\\*|\\#|\\&", "")) %>% 
  # if same code sum freqs
  group_by(CODE1, CODE2) %>% summarise(freq_finngen=sum(freq_finngen),  n_patients=sum(n_patients)) %>% ungroup()

n_events_finngen <- freq_icd10fi_finngen$freq_finngen %>% sum()
```


```{r}
 finngen_join <- left_join(freq_icd10fi_finngen, 
                           all_codes_tmp %>% mutate(is=TRUE, CODE1=str_replace(CODE1, "\\.", ""), CODE2=str_replace(CODE2, "\\.", ""))
                           , by = c("CODE1", "CODE2"))
```

**How many codes labeled as icd10fi in FinnGen are not in the icd10fi standard ?**
```{r paged.print=TRUE}
no_finngen_standard <- finngen_join %>% filter(is.na(is)) %>% select(CodeId, CODE1,  CODE2, freq_finngen) %>%
  mutate( freq_finngen_per=percent(freq_finngen/n_events_finngen))
```


```{r paged.print=TRUE}
no_finngen_standard %>% 
  filter((CODE1 != CODE2) | (is.na(CODE1)) | (is.na(CODE2)) ) %>% 
  filter(! (is.na(CODE1) & !is.na(CODE2)) ) %>%
  arrange(-freq_finngen)
```

Save these as: `finngefreq_finngen_not_in_icd10fi.csv`

Most of these are not found bcs they combination is not in `CodeId` but explained in `ALONG:Huom.`. This will be solved at the end of the process. 

```{r}
write_csv(no_finngen_standard, "./finngefreq_finngen_not_in_icd10fi.csv")
```









