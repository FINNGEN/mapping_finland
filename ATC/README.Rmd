---
title: "ATC"
output:
  github_document:
    toc: true
    df_print: kable
#   html_document:
#     df_print: paged
#     toc: true
---

```{r setup, include=FALSE}
rm(list = ls())

knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(scales)

source("../lib/vocabulary_reporting_fuctions.r")


# Document variables 
N_TOPS <- 10

# output status
db_statuses <- tibble()

```

```{r load, message=FALSE, warning=FALSE}
atc_concept <- read_csv("./1_source_vocabulary/CONCEPT_ATC.csv")

atc_mapsto <- read_csv("./2_mapping_to_standard/CONCEPT_RELATIONSHIP_ATC.csv")

atc_freqs <- read_csv("./3_freq_of_source_codes/freq_total.csv")
```


# Intro
TODO:


# Formating source vocabulary to OMOP
ATC codes are already part of the OMOP vocabularies. 

However, I notice that few old codes are missing and reported in the forum ([see post](https://forums.ohdsi.org/t/atc-alterations-missing-in-omop/11496/3)). 
In sort, ATC releases do not incude these any more and are out of the OMOP pipeline, but they could be included. 

ATC codes missing in OMOP are listed in [1_source_vocabulary/missing_atc_in_omop.csv](./1_source_vocabulary/missing_atc_in_omop.csv)


# Mapping the source vocabulary to the standard vocabularies
ATC codes are consider Classification codes in OMOP. 
However, there is a working group in OMOP with this aim [here](https://www.ohdsi.org/web/wiki/doku.php?id=projects:workgroups:atc). It seems to be difficult for some 5th level ATC codes. 

## Progess in number of codes
```{r}
n_codes <- atc_concept %>% nrow()
n_codes_accepted <- atc_mapsto %>% distinct(concept_id_1) %>% nrow()
```


From `r scales::number(n_codes)` codes `r scales::number(n_codes_accepted)` have been approved. 

This makes `r scales::percent(n_codes_accepted/n_codes)` of codes approved. 


```{r}
db_statuses <- bind_rows(
  tibble(
    status = "mapped",
    n_codes = n_codes_accepted,
    per_codes = percent(n_codes_accepted/!!n_codes),
    n_events = as.double(NA),
    per_events = as.character(NA), 
    db_name = "source"
  ),
 tibble(
    status = "not_mapped",
    n_codes = !!n_codes-n_codes_accepted,
    per_codes = percent((!!n_codes-n_codes_accepted)/!!n_codes),
    n_events =  as.double(NA),
    per_events = as.character(NA), 
    db_name = "source"
  )
)
```





# Assessing coverage of databases


```{r  results='asis'}

#write_csv(db_statuses, "status_table.csv" )
 database_coverage_md("ATC", atc_concept, atc_mapsto, atc_freqs, 
                      atc_missing_in_omop = read_csv("./1_source_vocabulary/missing_atc_in_omop.csv")
                      ) 

```
















