---
title: "Prepare ICD8fi codes for USAGI"
output: 
    github_document:
        df_print: tibble
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(scales)
library(readxl)
library(stringdist)
```

## Load

```{r load, message=FALSE, warning=FALSE}
icd9fi <- read_csv("./THL_ICD9fi_matched_ICD9CM_and_Wolfbane_ICD9.csv") 
freq_icd9fi_finngen <- read_csv("./freq_icd9fi_finngen.csv") %>% select(-X1)
```


Number of codes in each source: 
```{r}
icd9fi %>%  nrow()
freq_icd9fi_finngen %>%  nrow()
```
Number of icd8fi events in finngen :
```{r}
n_events_finngen <- freq_icd8fi_finngen$n_codes %>% sum()

number(n_events_finngen)
```
# study ICD9

```{r}
icd9fi %>%  count(match_type)
```

### Does full match agree on name ? 



```{r}
icd9fi %>% filter(match_type == "full_match")  %>% 
  mutate(ICD9TXT = str_to_lower(ICD9TXT), Wolfbane_name = str_to_lower(Wolfbane_name)) %>% 
        mutate(English_name_match_level = stringdist(ICD9TXT,Wolfbane_name) ) %>% 
        count(English_name_match_level) %>% head(20)
```






















## Study codes in FinnGen

```{r}
finngen_join <- left_join(freq_icd8fi_finngen %>% rename(Code=CODE1), icd8fi_standard, by = "Code") %>%
  mutate( freq_finngen_per=percent(n_codes/n_events_finngen))
```

**How many codes labeled as icd8fi in FinnGen are not in the icd8fi standard ?**
```{r paged.print=TRUE}
no_finngen_standard <- finngen_join %>% filter(is.na(DF6_Freq)) %>% select(Code, n_codes, freq_finngen_per, Finnish, English) 
```

There are `r no_finngen_standard %>%  nrow()` codes not found in the standard:

```{r paged.print=TRUE}
no_finngen_standard 
```

Lot of codes missing, not so much in absolute terms `r sum(no_finngen_standard$n_codes)/n_events_finngen*100 `


```{r}
finngen_standard <- finngen_join %>% filter(!is.na(DF6_Freq)) %>% select(Code, n_codes, freq_finngen_per, Finnish, English)
finngen_standard
```


```{r}
finngen_standard <- finngen_standard %>% mutate_if(is.numeric, ~if_else(is.na(.), rep(0, length(.)), .)) 

write_csv(finngen_standard, "./standard_icd8fi_with_freq.csv")
```



