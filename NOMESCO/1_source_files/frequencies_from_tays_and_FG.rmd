---
title: "Prepare NOMESCO codes for USAGI"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(scales)
library(DT)
```

## Load

```{r load, message=FALSE}
nomesco_standard <- read_delim("./standard_nomesco_kodistopalvelu_119_1510562053330.txt", delim = ";",
                               locale = locale(encoding = "ISO-8859-1"), 
                               col_types = cols( .default = col_character() ))
freq_nomesco_finngen <- read_csv("./freq_nomesco_finngen.csv", )
freq_procedures_tays <- read_csv("./freq_procedures_tays.csv",locale = locale(encoding = "ISO-8859-1"))
```


Number of codes in each source: 
```{r}
nomesco_standard %>%  nrow()
freq_nomesco_finngen %>%  nrow()
freq_procedures_tays  %>%  nrow()
```
Number of events in each data base :
```{r}
n_events_finngen <- freq_nomesco_finngen$freq %>% sum()
n_events_tays <- freq_procedures_tays$yhteensa %>% sum()

n_events_finngen
n_events_tays
```


## Study codes in FinnGen

```{r}
finngen_join <- full_join(nomesco_standard , freq_nomesco_finngen %>% mutate(CodeId=CODE1) %>%  rename(freq_finngen=freq), by = "CodeId")
```

**How many codes labeled as NOMESCO in FinnGen are not in the NOMESCO standard ?**
```{r paged.print=TRUE}
no_finngen_standard <- finngen_join %>% filter(is.na(ShortName)) %>% select(CodeId, ShortName, CODE1, freq_finngen) %>%
  mutate( freq_finngen_per=percent(freq_finngen/n_events_finngen))
```

There are `r no_finngen_standard %>%  nrow()` codes not found in the standard : 

```{r paged.print=TRUE}
no_finngen_standard
```

Save these as: `finngen_codes_not_in_nomesco.csv`
```{r}
write_csv(no_finngen_standard, "./finngen_codes_not_in_nomesco.csv")
```


```{r}
finngen_standard <- finngen_join %>% filter(!is.na(ShortName)) %>% select(CodeId, freq_finngen)
```



## Study codes in TAYS

```{r}
tays_join <- full_join(nomesco_standard , freq_procedures_tays %>% mutate(CodeId=TOIMENPIDE) %>%  rename(freq_tays=yhteensa), by = "CodeId")
```

**How many codes labeled as NOMESCO in FinnGen are not in the NOMESCO standard ?**
```{r paged.print=TRUE}
no_tays_standard <- tays_join %>% filter(is.na(ShortName)) %>% select(CodeId, ShortName, TOIMENPIDE, freq_tays) %>%
  mutate( freq_tays_per=percent(freq_tays/n_events_tays))
```

There are `r no_tays_standard %>%  nrow()` codes not found in the standard : 

```{r paged.print=TRUE}
no_tays_standard
```

Save these as: `tays_codes_not_in_nomesco.csv`
```{r}
write_csv(no_tays_standard, "./tays_codes_not_in_nomesco.csv")
```


```{r}
tays_standard <- tays_join %>% filter(!is.na(ShortName)) %>% select(CodeId, freq_tays)
```


# Merge all 

```{r}
tmp <- left_join(nomesco_standard, finngen_standard, by = "CodeId")
nomesco_standard_with_freqs <- left_join(tmp ,  tays_standard, by = "CodeId")
```

```{r}
nomesco_standard_with_freqs <- nomesco_standard_with_freqs %>%   mutate(freq_total = (freq_finngen+freq_tays))

nomesco_standard_with_freqs %>%  arrange(-freq_total) %>%  select(CodeId,  freq_finngen, freq_tays, freq_total) %>% 
  mutate(freq_total_per = scales::percent(freq_total/(n_events_finngen+n_events_tays)))
```

Save as: `standard_nomesco_with_freq.csv`

```{r}
nomesco_standard_with_freqs <- nomesco_standard_with_freqs %>% mutate_if(is.numeric, ~if_else(is.na(.), rep(0, length(.)), .)) 

write_csv(nomesco_standard_with_freqs %>% select(CodeId, LongName, ParentId, HierarchyLevel, BeginningDate, ExpiringDate, LastModifiedDate,
                                 `A:Long_name`, freq_finngen, freq_tays, freq_total), "./standard_nomesco_with_freq.csv")
```



